# BitTune

Bitcoin + Nostr music streaming POC.

## Prerequisites

- Docker & Docker Compose
- Node.js 18+

## Setup

1. **Start Database**
   ```bash
   cd docker
   docker-compose up -d
   cd ..
   ```

2. **Install Dependencies**
   ```bash
   cd apps/web
   npm install
   ```
   *Note: This repo uses strict directory structure.*

3. **Configure Environment**
   Copy the example environment variables to the web app:
   ```bash
   # From root
   cp .env.example apps/web/.env
   ```
   Modify `apps/web/.env` if you changed Docker credentials.

4. **Initialize Database**
   ```bash
   cd apps/web
   npx prisma migrate dev --name init
   npx prisma db seed
   ```

5. **Run the App**
   ```bash
   npm run dev
   ```
   Open [http://localhost:3000](http://localhost:3000).

## Features

- **Nostr Login**: Uses NIP-07 extension (Alby, nos2x).
- **Upload**: Mock upload creating Track and Nostr Event (Kind 31337).
- **Listen (PoE)**: Playing a track emits periodic heartbeat events (Kind 31338).
- **Monetization**: Sessions verified server-side. Eligible sessions trigger Payout via Artist's NWC.
- **Wallet Connect**: Artists can connect NWC to receive payouts.
- **Lightning Payouts**: Platform triggers payouts via NWC (Platform pays Invoice generated by Artist Wallet).

## NWC Setup (Artist)

1.  **Get Connection String**: Use a wallet like Alby or Mutiny to create a new "Budget" or "App" connection. Copy the `nostr+walletconnect://...` string.
2.  **Connect**: Go to `/wallet` in BitTune, verify with "Test Connection", and Save.
3.  **Payouts**: Accumulate 60s of listening time. A payout request (mocked or real if enabled) will be triggered.

## Treasury Setup (Platform)

Set `PLATFORM_TREASURY_NWC` in `.env` to the connection string of the funding wallet.
ensure `NWC_ENCRYPTION_KEY` is a 32-byte base64 string for secure storage of artist credentials.

## Uploading Real Audio

BitTune supports local and S3-compatible storage.

### 1. Local Storage (Default)
set `STORAGE_MODE="local"` in `.env`. Files are uploaded to `public/uploads` and served directly.

### 2. S3 / R2
set `STORAGE_MODE="s3"` and configure:
```bash
S3_ENDPOINT=https://<accountid>.r2.cloudflarestorage.com
S3_BUCKET=my-bucket
S3_ACCESS_KEY_ID=...
S3_SECRET_ACCESS_KEY=...
S3_PUBLIC_BASE_URL=https://pub-domain.com
```
PoE and payouts leverage `trackId` and operate independently of the storage backend.
